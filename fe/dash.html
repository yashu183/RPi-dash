<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi 4B Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    backdropBlur: {
                        xs: '2px'
                    }
                }
            }
        }

        // Add custom animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .glass-effect {
                backdrop-filter: blur(10px);
                background: rgba(31, 41, 55, 0.8);
                border: 1px solid rgba(75, 85, 99, 0.3);
            }
            .progress-glow {
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            }
        `;
        document.head.appendChild(style);
    </script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen">
    <!-- Initial Loading Screen -->
    <div id="initialLoader" class="fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-2xl font-semibold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-2">Loading Dashboard</h2>
            <p class="text-gray-400">Fetching system data...</p>
        </div>
    </div>

    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-3">Raspberry Pi 4B Dashboard</h1>
            <p class="text-gray-300 text-lg" id="lastUpdated">Last updated: --</p>
        </div>

        <!-- Status Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- System Info Card -->
            <div class="glass-effect rounded-xl p-6 shadow-2xl hover:shadow-blue-500/10 transition-all duration-300 animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">System Info</h2>
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse-slow"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Hostname:</span>
                        <span id="hostname">raspberry-pi</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Uptime:</span>
                        <span id="uptime">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Platform:</span>
                        <span id="platform">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Architecture:</span>
                        <span id="architecture">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Date:</span>
                        <span id="currentDate">--</span>
                    </div>
                </div>
            </div>

            <!-- CPU Card -->
            <div class="glass-effect rounded-xl p-6 shadow-2xl hover:shadow-blue-500/10 transition-all duration-300 animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">CPU</h2>
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse-slow"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Temperature:</span>
                        <span id="cpuTemp" class="font-mono">--Â°C</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Usage:</span>
                        <span id="cpuUsage" class="font-mono">--%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Cores:</span>
                        <span id="cpuCores" class="font-mono">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Frequency:</span>
                        <span id="cpuFreq" class="font-mono">-- MHz</span>
                    </div>
                    <div class="w-full bg-gray-700/50 rounded-full h-3 shadow-inner">
                        <div id="cpuBar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-700 progress-glow" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-300 mt-2 font-medium">
                        <span id="cpuPercent">0%</span> used
                    </div>
                </div>
            </div>

            <!-- Memory Card -->
            <div class="glass-effect rounded-xl p-6 shadow-2xl hover:shadow-purple-500/10 transition-all duration-300 animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Memory</h2>
                    <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse-slow"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Used:</span>
                        <span id="memUsed" class="font-mono">-- GB</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Free:</span>
                        <span id="memFree" class="font-mono">-- GB</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total:</span>
                        <span id="memTotal" class="font-mono">-- GB</span>
                    </div>
                    <div class="w-full bg-gray-700/50 rounded-full h-3 shadow-inner">
                        <div id="memBar" class="bg-gradient-to-r from-purple-400 to-purple-600 h-3 rounded-full transition-all duration-700 progress-glow" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-300 mt-2 font-medium">
                        <span id="memPercent">0%</span> used
                    </div>
                </div>
            </div>

            <!-- Storage Card -->
            <div class="glass-effect rounded-xl p-6 shadow-2xl hover:shadow-yellow-500/10 transition-all duration-300 animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Root Storage</h2>
                    <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse-slow"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Used:</span>
                        <span id="diskUsed" class="font-mono">-- GB</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Free:</span>
                        <span id="diskFree" class="font-mono">-- GB</span>
                    </div>
                    <div class="w-full bg-gray-700/50 rounded-full h-3 shadow-inner">
                        <div id="diskBar" class="bg-gradient-to-r from-yellow-400 to-orange-500 h-3 rounded-full transition-all duration-700 progress-glow" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-300 mt-2 font-medium">
                        <span id="diskPercent">0%</span> used
                    </div>
                </div>
            </div>

            <!-- Docker Status Card -->
            <div class="glass-effect rounded-xl p-6 shadow-2xl hover:shadow-green-500/10 transition-all duration-300 animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Docker</h2>
                    <div id="dockerStatus" class="w-3 h-3 bg-gray-500 rounded-full"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Status:</span>
                        <span id="dockerStatusText">Checking...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Containers:</span>
                        <span id="dockerContainers" class="font-mono">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Running:</span>
                        <span id="dockerRunning" class="font-mono text-green-400">--</span>
                    </div>
                    <div id="dockerError" class="text-xs text-red-400 mt-2 hidden">
                        <!-- Docker error message will appear here -->
                    </div>
                </div>
            </div>

            <!-- Cloudflared Status Card -->
            <div class="glass-effect rounded-xl p-6 shadow-2xl hover:shadow-green-500/10 transition-all duration-300 animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Cloudflared</h2>
                    <div id="cloudflaredStatus" class="w-3 h-3 bg-gray-500 rounded-full"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Status:</span>
                        <span id="cloudflaredStatusText">Checking...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Tunnel:</span>
                        <span id="cloudflaredTunnel" class="font-mono">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Uptime:</span>
                        <span id="cloudflaredUptime" class="font-mono">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disk Devices Section -->
        <div class="glass-effect rounded-xl p-6 shadow-2xl mb-6 animate-slide-up">
            <h2 class="text-xl font-semibold mb-4">Storage Devices</h2>
            <div class="space-y-4" id="diskDevicesList">
                <!-- Disk devices will be populated here -->
            </div>
        </div>

        <!-- Services Section -->
        <div class="glass-effect rounded-xl p-6 shadow-2xl animate-slide-up">
            <h2 class="text-xl font-semibold mb-4">Services Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="servicesList">
                <!-- Services will be populated here -->
            </div>
        </div>

        <!-- Refresh Button -->
        <div class="text-center mt-8">
            <button id="refreshBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 px-8 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                Refresh Data
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-6 mt-8 border-t border-gray-700/50">
        <p class="text-gray-400 text-sm">Â© 2025 Developed by Yashwanth C</p>
    </footer>

    <script>
        // API Configuration - Change this to match your setup
        const API_BASE = 'http://192.168.29.111:5555/api';
        // For remote access, use: const API_BASE = 'http://YOUR_PI_IP:5000/api';

        // Track if this is the first load
        let isFirstLoad = true;
        
        // Fetch real data from API
        async function fetchSystemData() {
            try {
                const response = await fetch(`${API_BASE}/all`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching system data:', error);
                // Fallback to individual API calls if /all endpoint fails
                return await fetchSystemDataIndividually();
            }
        }

        // Fallback: fetch data from individual endpoints
        async function fetchSystemDataIndividually() {
            const [system, cpu, memory, disk, docker, cloudflared, services] = await Promise.all([
                fetch(`${API_BASE}/system`).then(r => r.json()),
                fetch(`${API_BASE}/cpu`).then(r => r.json()),
                fetch(`${API_BASE}/memory`).then(r => r.json()),
                fetch(`${API_BASE}/disk`).then(r => r.json()),
                fetch(`${API_BASE}/docker`).then(r => r.json()),
                fetch(`${API_BASE}/cloudflared`).then(r => r.json()),
                fetch(`${API_BASE}/services`).then(r => r.json())
            ]);

            return { system, cpu, memory, disk, docker, cloudflared, services };
        }

        async function updateDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');

            // Only show refresh button loading state if not first load
            if (!isFirstLoad) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';
            }

            try {
                const data = await fetchSystemData();
                
                // Update "Last updated" with server time (when data was fetched)
                const serverTime = data.timestamp || data.system.date;
                document.getElementById('lastUpdated').textContent = `Last updated: ${serverTime}`;

                // Update current system date with real-time
                const currentTime = new Date().toLocaleString('en-CA', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(',', '');

                // Update the system date field to show current time
                document.getElementById('currentDate').textContent = currentTime;
                
                // System info
                document.getElementById('hostname').textContent = data.system.hostname;
                document.getElementById('uptime').textContent = data.system.uptime;
                document.getElementById('platform').textContent = data.system.platform;
                document.getElementById('architecture').textContent = data.system.architecture;
                // currentDate is now updated above with current browser time
                
                // CPU
                const cpuTemp = data.cpu.temperature;
                const cpuUsage = data.cpu.usage;
                
                if (cpuTemp !== null) {
                    document.getElementById('cpuTemp').textContent = `${cpuTemp}Â°C`;
                    // Color coding for CPU temp
                    const tempElement = document.getElementById('cpuTemp');
                    if (cpuTemp > 70) {
                        tempElement.className = 'font-mono text-red-400';
                    } else if (cpuTemp > 60) {
                        tempElement.className = 'font-mono text-yellow-400';
                    } else {
                        tempElement.className = 'font-mono text-green-400';
                    }
                } else {
                    document.getElementById('cpuTemp').textContent = 'N/A';
                    document.getElementById('cpuTemp').className = 'font-mono text-gray-400';
                }
                
                document.getElementById('cpuUsage').textContent = `${cpuUsage}%`;
                document.getElementById('cpuCores').textContent = data.cpu.cores;
                document.getElementById('cpuFreq').textContent = `${data.cpu.frequency} MHz`;
                document.getElementById('cpuBar').style.width = `${cpuUsage}%`;
                document.getElementById('cpuPercent').textContent = `${cpuUsage}%`;
                
                // Memory
                const memUsedGB = data.memory.used;
                const memTotalGB = data.memory.total;
                const memAvailableGB = data.memory.available;
                const memPercent = data.memory.percent;
                document.getElementById('memUsed').textContent = `${memUsedGB.toFixed(2)} GB`;
                document.getElementById('memFree').textContent = `${memAvailableGB.toFixed(2)} GB`;
                document.getElementById('memTotal').textContent = `${memTotalGB.toFixed(2)} GB`;
                document.getElementById('memBar').style.width = `${memPercent}%`;
                document.getElementById('memPercent').textContent = `${memPercent.toFixed(1)}%`;

                // Storage (use root partition data)
                const rootPartition = data.disk.devices.find(device =>
                    device.children && device.children.some(child => child.mountpoint === '/')
                )?.children.find(child => child.mountpoint === '/');

                if (rootPartition) {
                    const diskUsedGB = rootPartition.usage.used;
                    const diskTotalGB = rootPartition.usage.total;
                    const diskFreeGB = rootPartition.usage.free;
                    const diskPercent = rootPartition.usage.percent;

                    document.getElementById('diskUsed').textContent = `${diskUsedGB.toFixed(1)} GB`;
                    document.getElementById('diskFree').textContent = `${diskFreeGB.toFixed(1)} GB`;
                    document.getElementById('diskBar').style.width = `${diskPercent}%`;
                    document.getElementById('diskPercent').textContent = `${diskPercent.toFixed(1)}%`;
                } else {
                    document.getElementById('diskUsed').textContent = 'N/A';
                    document.getElementById('diskFree').textContent = 'N/A';
                    document.getElementById('diskBar').style.width = '0%';
                    document.getElementById('diskPercent').textContent = '0%';
                }
                
                // Docker
                const dockerStatusEl = document.getElementById('dockerStatus');
                const dockerStatusText = document.getElementById('dockerStatusText');
                if (data.docker.status === 'running') {
                    dockerStatusEl.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse-slow';
                    dockerStatusText.textContent = 'Running';
                    dockerStatusText.className = 'text-green-400';
                } else if (data.docker.status === 'stopped') {
                    dockerStatusEl.className = 'w-3 h-3 bg-red-500 rounded-full';
                    dockerStatusText.textContent = 'Stopped';
                    dockerStatusText.className = 'text-red-400';
                } else {
                    dockerStatusEl.className = 'w-3 h-3 bg-gray-500 rounded-full';
                    dockerStatusText.textContent = 'Unknown';
                    dockerStatusText.className = 'text-gray-400';
                }
                document.getElementById('dockerContainers').textContent = data.docker.containers;
                document.getElementById('dockerRunning').textContent = data.docker.running;

                // Show Docker error if present
                const dockerErrorEl = document.getElementById('dockerError');
                if (data.docker.error) {
                    dockerErrorEl.textContent = data.docker.error;
                    dockerErrorEl.classList.remove('hidden');
                } else {
                    dockerErrorEl.classList.add('hidden');
                }
                
                // Cloudflared
                const cloudflaredStatusEl = document.getElementById('cloudflaredStatus');
                const cloudflaredStatusText = document.getElementById('cloudflaredStatusText');
                if (data.cloudflared.status === 'connected') {
                    cloudflaredStatusEl.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse-slow';
                    cloudflaredStatusText.textContent = 'Connected';
                    cloudflaredStatusText.className = 'text-green-400';
                } else if (data.cloudflared.status === 'disconnected') {
                    cloudflaredStatusEl.className = 'w-3 h-3 bg-red-500 rounded-full';
                    cloudflaredStatusText.textContent = 'Disconnected';
                    cloudflaredStatusText.className = 'text-red-400';
                } else {
                    cloudflaredStatusEl.className = 'w-3 h-3 bg-gray-500 rounded-full';
                    cloudflaredStatusText.textContent = 'Unknown';
                    cloudflaredStatusText.className = 'text-gray-400';
                }
                document.getElementById('cloudflaredTunnel').textContent = data.cloudflared.tunnel;
                document.getElementById('cloudflaredUptime').textContent = data.cloudflared.uptime;
                
                // Services
                const servicesList = document.getElementById('servicesList');
                servicesList.innerHTML = '';
                data.services.forEach(service => {
                    const serviceEl = document.createElement('div');
                    serviceEl.className = 'flex justify-between items-center p-4 bg-gray-700/30 backdrop-blur-sm rounded-lg border border-gray-600/30 hover:bg-gray-600/40 transition-all duration-300';

                    let statusClass, statusIcon;
                    switch(service.status) {
                        case 'running':
                        case 'active':
                            statusClass = 'text-green-400';
                            statusIcon = 'â';
                            break;
                        case 'stopped':
                        case 'inactive':
                            statusClass = 'text-red-400';
                            statusIcon = 'â';
                            break;
                        default:
                            statusClass = 'text-gray-400';
                            statusIcon = '?';
                    }

                    serviceEl.innerHTML = `
                        <span>${service.name}</span>
                        <span class="${statusClass}">${statusIcon} ${service.status}</span>
                    `;
                    servicesList.appendChild(serviceEl);
                });

                // Disk Devices (skip mmcblk devices since root storage is already shown above)
                const diskDevicesList = document.getElementById('diskDevicesList');
                diskDevicesList.innerHTML = '';
                data.disk.devices.filter(device => !device.name.startsWith('mmcblk')).forEach(device => {
                    const deviceEl = document.createElement('div');
                    deviceEl.className = 'bg-gray-700/30 backdrop-blur-sm rounded-xl p-5 border border-gray-600/30 hover:border-gray-500/50 transition-all duration-300';

                    let deviceInfo = `
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-medium">${device.name}</h3>
                            <span class="text-sm text-gray-400">${device.size}</span>
                        </div>
                    `;

                    if (device.children && device.children.length > 0) {
                        device.children.forEach(partition => {
                            const usage = partition.usage;
                            const usagePercent = usage ? usage.percent : 0;
                            const mountpoint = partition.mountpoint || 'Not mounted';

                            deviceInfo += `
                                <div class="mb-3 p-4 bg-gray-600/40 backdrop-blur-sm rounded-lg border border-gray-500/20">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium">${partition.name}</span>
                                        <span class="text-sm text-gray-300">${partition.size}</span>
                                    </div>
                                    <div class="text-sm text-gray-400 mb-2">
                                        Mount: ${mountpoint}
                                    </div>
                                    ${usage ? `
                                        <div class="flex justify-between text-sm mb-1">
                                            <span>Used: ${usage.used.toFixed(1)}GB</span>
                                            <span>Free: ${usage.free.toFixed(1)}GB</span>
                                        </div>
                                        <div class="w-full bg-gray-800/50 rounded-full h-2.5 shadow-inner">
                                            <div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: ${usagePercent}%"></div>
                                        </div>
                                        <div class="text-xs text-gray-400 mt-1">${usagePercent.toFixed(1)}% used</div>
                                    ` : '<div class="text-sm text-gray-400">No usage data</div>'}
                                </div>
                            `;
                        });
                    }

                    deviceEl.innerHTML = deviceInfo;
                    diskDevicesList.appendChild(deviceEl);
                });

                // Hide initial loader on first successful load
                if (isFirstLoad) {
                    const initialLoader = document.getElementById('initialLoader');
                    initialLoader.style.opacity = '0';
                    initialLoader.style.transition = 'opacity 0.5s ease-out';
                    setTimeout(() => {
                        initialLoader.style.display = 'none';
                    }, 500);
                    isFirstLoad = false;
                }

            } catch (error) {
                console.error('Failed to update dashboard:', error);
                // Show error in the UI
                document.getElementById('lastUpdated').textContent = `Error: ${error.message}`;
            } finally {
                // Only update refresh button if not first load
                if (!isFirstLoad) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh Data';
                }
            }
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', updateDashboard);

        // Auto-refresh every 30 seconds
        setInterval(updateDashboard, 30000);

        // Initial load
        updateDashboard();
    </script>
</body>
</html>
